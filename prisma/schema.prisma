generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(uuid())
  email            String            @unique
  name             String?
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  password         String
  deleted_at       DateTime?
  role             UserRole          @default(USER)
  avatar           String?
  stripeCustomerId String?           @unique @map("stripe_customer_id")
  philosophies     Philosophy[]
  priceAlerts      PriceAlert[]
  strategyProfiles StrategyProfile[]
  subscription     Subscription?
  transactions     Transaction[]
  wallets          Wallet[]

  @@map("users")
}

model Philosophy {
  id               String   @id @default(uuid())
  title            String
  description      String?
  filePath         String   @map("file_path")
  extractedText    String   @map("extracted_text")
  rules            String[]
  userId           String   @map("user_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  structured_rules Json?
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("philosophies")
}

model Asset {
  id                     String        @id @default(uuid())
  ticker                 String        @unique
  name                   String
  type                   String
  sector                 String?
  currentPrice           Decimal?      @map("current_price") @db.Decimal(12, 2)
  dividendYield          Decimal?      @map("dividend_yield") @db.Decimal(5, 4)
  priceToEarnings        Decimal?      @map("price_to_earnings") @db.Decimal(8, 2)
  priceToBook            Decimal?      @map("price_to_book") @db.Decimal(8, 2)
  roe                    Decimal?      @db.Decimal(5, 4)
  netMargin              Decimal?      @map("net_margin") @db.Decimal(5, 4)
  debtToEquity           Decimal?      @map("debt_to_equity") @db.Decimal(8, 2)
  lastUpdated            DateTime?     @map("last_updated")
  createdAt              DateTime      @default(now()) @map("created_at")
  updatedAt              DateTime      @updatedAt @map("updated_at")
  deleted_at             DateTime?
  average_purchase_price Decimal?      @db.Decimal(12, 2)
  dividends              Dividend[]
  priceAlerts            PriceAlert[]
  walletAssets           WalletAsset[]

  @@index([sector])
  @@index([type])
  @@map("assets")
}

model StrategyProfile {
  id          String   @id @default(uuid())
  name        String
  description String?
  rules       Json
  sourceType  String?  @map("source_type")
  sourceRef   String?  @map("source_ref")
  isActive    Boolean  @default(true) @map("is_active")
  userId      String   @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([userId])
  @@map("strategy_profiles")
}

model Wallet {
  id        String        @id @default(uuid())
  name      String
  userId    String        @map("user_id")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  assets    WalletAsset[]
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("wallets")
}

model WalletAsset {
  id           String   @id @default(uuid())
  walletId     String   @map("wallet_id")
  assetId      String   @map("asset_id")
  quantity     Decimal  @db.Decimal(18, 8)
  averagePrice Decimal  @map("average_price") @db.Decimal(12, 2)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  asset        Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  wallet       Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@unique([walletId, assetId])
  @@index([assetId])
  @@index([walletId])
  @@map("wallet_assets")
}

model Dividend {
  id          String   @id @default(uuid())
  assetId     String   @map("asset_id")
  paymentDate DateTime @map("payment_date")
  exDate      DateTime @map("ex_date")
  value       Decimal  @db.Decimal(10, 4)
  type        String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  asset       Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([assetId, paymentDate, type])
  @@index([assetId])
  @@index([paymentDate])
  @@map("dividends")
}

model PriceAlert {
  id          String         @id @default(uuid())
  userId      String         @map("user_id")
  assetId     String         @map("asset_id")
  targetPrice Decimal        @map("target_price") @db.Decimal(10, 2)
  condition   AlertCondition
  isActive    Boolean        @default(true) @map("is_active")
  triggeredAt DateTime?      @map("triggered_at")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  asset       Asset          @relation(fields: [assetId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([isActive])
  @@index([userId])
  @@map("price_alerts")
}

model Plan {
  id              String         @id @default(uuid())
  name            String         @unique
  displayName     String
  description     String?
  price           Decimal        @default(0) @db.Decimal(10, 2)
  interval        PlanInterval   @default(MONTHLY)
  features        Json
  maxAssets       Int?
  maxWallets      Int?
  maxAlerts       Int?
  aiAnalysis      Boolean        @default(false)
  prioritySupport Boolean        @default(false)
  customizable    Boolean        @default(false)
  active          Boolean        @default(true)
  sortOrder       Int            @default(0)
  stripePriceId   String?        @map("stripe_price_id")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  subscriptions   Subscription[]

  @@map("plans")
}

model Subscription {
  id           String             @id @default(uuid())
  userId       String             @unique @map("user_id")
  planId       String             @map("plan_id")
  status       SubscriptionStatus @default(ACTIVE)
  startDate    DateTime           @default(now()) @map("start_date")
  endDate      DateTime?          @map("end_date")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")
  plan         Plan               @relation(fields: [planId], references: [id])
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("subscriptions")
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String
  details   Json?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt])
  @@map("activity_logs")
}

model EconomicIndicator {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  value       Float
  lastUpdated DateTime @map("last_updated")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("economic_indicators")
}

model Transaction {
  id             String            @id @default(uuid())
  userId         String            @map("user_id")
  subscriptionId String?           @map("subscription_id")
  gateway        PaymentGateway
  gatewayTxId    String?           @map("gateway_tx_id")
  amount         Decimal           @db.Decimal(10, 2)
  currency       String            @default("BRL")
  status         TransactionStatus
  type           TransactionType
  metadata       Json?
  errorMessage   String?           @map("error_message")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")
  processedAt    DateTime?         @map("processed_at")
  subscription   Subscription?     @relation(fields: [subscriptionId], references: [id])
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([gatewayTxId])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

model ExternalApiLog {
  id              String   @id @default(uuid())
  provider        String
  endpoint        String
  method          String
  requestHeaders  Json?    @map("request_headers")
  requestBody     Json?    @map("request_body")
  statusCode      Int?     @map("status_code")
  responseHeaders Json?    @map("response_headers")
  responseBody    Json?    @map("response_body")
  duration        Int?
  success         Boolean
  errorMessage    String?  @map("error_message")
  userId          String?  @map("user_id")
  transactionId   String?  @map("transaction_id")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([provider])
  @@index([createdAt])
  @@index([transactionId])
  @@map("external_api_logs")
}

model PaymentGatewayConfig {
  id         String         @id @default(uuid())
  gateway    PaymentGateway @unique
  apiKey     String         @map("api_key")
  secretKey  String         @map("secret_key")
  webhookKey String?        @map("webhook_key")
  isActive   Boolean        @default(false) @map("is_active")
  isTest     Boolean        @default(true) @map("is_test")
  config     Json?
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")

  @@map("payment_gateway_configs")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum AlertCondition {
  ABOVE
  BELOW
  EQUAL
}

enum AssetType {
  STOCK
  FII
  ETF
  BDR
  CRYPTO
}

enum PlanInterval {
  MONTHLY
  YEARLY
  LIFETIME
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  TRIAL
}

enum PaymentGateway {
  STRIPE
  PAGARME
  MERCADOPAGO
}

enum TransactionStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELED
}

enum TransactionType {
  SUBSCRIPTION_CREATE
  SUBSCRIPTION_RENEW
  UPGRADE
  DOWNGRADE
  REFUND
}
